

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>jupyter: jupytext: formats: ipynb,md text_representation: extension: .md format_name: markdown format_version: ‘1.2’ jupytext_version: 1.7.1 kernelspec: display_name: Python 3 language: python name: python3 &mdash; The Multi-Mission Maximum Likelihood framework  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/favicon.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/@jupyter-widgets/html-manager@^0.21.0-alpha.0/dist/embed-amd.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <link rel="stylesheet" href="../../_static/pygments/default.css" type="text/css" id="pygments-style">
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css">
   

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> The Multi-Mission Maximum Likelihood framework
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">Intro</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/logging.html">Logging and Verbosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../xspec_users.html">Notes for XSPEC Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Bayesian_tutorial.html">Bayesian Posterior Sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins.html">Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modeling.html">Modeling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/API.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/API.html#threeml">threeML</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../release_notes.html">Release Notes</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Features and examples:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Analysis_results_showcase.html">Analysis Results</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/random_variates.html">Random Variates</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Point_source_plotting.html">Point source plotting basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Building_Plugins_from_TimeSeries.html">Constructing plugins from TimeSeries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/grb080916C.html">Analyzing GRB 080916C</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/joint_BAT_gbm_demo.html">Example joint fit between GBM and Swift BAT</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/joint_fitting_xrt_and_gbm_xspec_models.html">Joint fitting XRT and GBM data with XSPEC models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/flux_examples.html">Point Source Fluxes and Multiple Sources</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/Time-energy-fit.html">Time-energy fit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/synthetic_spectra.html">Generating Synthetic Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/gof_lrt.html">Goodness of Fit and Model Comparison</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/APEC_doc.html">Fitting XMM-Newton data with the APEC model</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">The Multi-Mission Maximum Likelihood framework</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
  <!--
  <div class="admonition note">
    <p><a href="https://github.com/lukelbd">ProPlot author here</a>: Due to my day job as a graduate student, certain <a href="https://github.com/lukelbd/proplot/pulls?q=is%3Aopen+is%3Apr">feature additions</a> may be delayed to the summer of 2020. In the meantime, if you are interested in contributing to ProPlot, please see the <a href="https://proplot.readthedocs.io/en/latest/contributions.html">contribution guide</a>. Any amount of help is welcome!
    </p>
  </div>
  -->
  <li id="lightdark-li">
    <label for="lightdark-checkbox" id="lightdark-label">
      <input type="checkbox" id="lightdark-checkbox"/>
      <div class="btn-neutral"></div>
    </label>
  </li>
  
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>jupyter:
jupytext:
formats: ipynb,md
text_representation:
extension: .md
format_name: markdown
format_version: ‘1.2’
jupytext_version: 1.7.1
kernelspec:
display_name: Python 3
language: python
name: python3</li>
    

    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
  <script type="text/javascript" src=../../_static/custom.js></script>
  
           <div itemprop="articleBody">
            
  
<style>
/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<hr class="docutils" />
<div class="section" id="jupyter-jupytext-formats-ipynb-md-text-representation-extension-md-format-name-markdown-format-version-1-2-jupytext-version-1-7-1-kernelspec-display-name-python-3-language-python-name-python3">
<h1>jupyter:
jupytext:
formats: ipynb,md
text_representation:
extension: .md
format_name: markdown
format_version: ‘1.2’
jupytext_version: 1.7.1
kernelspec:
display_name: Python 3
language: python
name: python3<a class="headerlink" href="#jupyter-jupytext-formats-ipynb-md-text-representation-extension-md-format-name-markdown-format-version-1-2-jupytext-version-1-7-1-kernelspec-display-name-python-3-language-python-name-python3" title="Permalink to this headline">¶</a></h1>
</div>
<div class="section" id="hal-hawc-accelerated-likelihood-plugin">
<h1>HAL (HAWC Accelerated Likelihood) plugin<a class="headerlink" href="#hal-hawc-accelerated-likelihood-plugin" title="Permalink to this headline">¶</a></h1>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>The High-Altitude Water Cherenkov Observatory (<a class="reference external" href="https://www.hawc-observatory.org/">HAWC</a>) is a ground-based wide-field TeV gamma-ray observatory located in Mexico, scanning about 2/3 of the northern sky every day. It is sensitive to gamma rays in the energy range from hundreds of GeV to hundreds of TeV. In addition to gamma ray-induced air showers, HAWC also detects signals from cosmic-ray induced air showers, which make up the main (and partially irreducible) background. HAWC uses a forward-folding likelihood analysis, similar to the approach that is used e.g. by many Fermi-LAT analyses. Most of HAWC’s data are only available to collaboration members. However, HAWC has released several <a class="reference external" href="https://data.hawc-observatory.org/">partial-sky datasets</a> to the public, and is committed to releasing more in the future. If you are interested in a particular HAWC dataset, you can find contact information for HAWC working group leaders on the linked webpage.</p>
<p>The HAL (HAWC accelerated likelihood) plugin for threeML is provided in a separate python package, <code class="docutils literal notranslate"><span class="pre">hawc_hal</span></code>. Before running this example offline, make sure that the <code class="docutils literal notranslate"><span class="pre">HAL</span></code> plugin is installed. The <code class="docutils literal notranslate"><span class="pre">hawc_hal</span></code> package needs <code class="docutils literal notranslate"><span class="pre">root_numpy</span></code> as a dependency. It can be installed as follows (skip the first step if you already have threeML/astromodels installed):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">name</span> <span class="n">hal_env</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> <span class="o">-</span><span class="n">c</span> <span class="n">threeml</span> <span class="n">numpy</span> <span class="n">scipy</span> <span class="n">matplotlib</span> <span class="n">ipython</span> <span class="n">numba</span> <span class="n">reproject</span> <span class="s2">&quot;astromodels&gt;=2&quot;</span> <span class="s2">&quot;threeml&gt;=2&quot;</span> <span class="n">root</span>
<span class="n">conda</span> <span class="n">activate</span> <span class="n">hal_env</span>
<span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">binary</span> <span class="p">:</span><span class="nb">all</span><span class="p">:</span> <span class="n">root_numpy</span>
<span class="n">pip</span> <span class="n">install</span> <span class="n">git</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">threeml</span><span class="o">/</span><span class="n">hawc_hal</span><span class="o">.</span><span class="n">git</span>
</pre></div>
</div>
<div class="section" id="download">
<h2>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h2>
<p>First, download the 507 day Crab dataset and instrument response file from the HAWC webpage.
In case of problems with the code below, the files can be downloaded manually from https://data.hawc-observatory.org/datasets/crab_data/index.php . If the files already exist, the code won’t try to overwrite them.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">def</span> <span class="nf">get_hawc_file</span><span class="p">(</span> <span class="n">filename</span><span class="p">,</span> <span class="n">odir</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span><span class="p">,</span> <span class="n">overwrite</span> <span class="o">=</span> <span class="kc">False</span> <span class="p">):</span>

    <span class="k">if</span> <span class="n">overwrite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span> <span class="n">odir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">url</span><span class="o">=</span><span class="s2">&quot;https://data.hawc-observatory.org/datasets/crab_data/public_data/crab_2017/&quot;</span>

        <span class="n">req</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="o">+</span><span class="n">filename</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">req</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">decode_content</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span> <span class="n">odir</span> <span class="o">+</span> <span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">raw</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>    
        
    <span class="k">return</span> <span class="n">odir</span> <span class="o">+</span> <span class="n">filename</span>
        

<span class="n">maptree</span> <span class="o">=</span> <span class="s2">&quot;HAWC_9bin_507days_crab_data.hd5&quot;</span>
<span class="n">response</span> <span class="o">=</span> <span class="s2">&quot;HAWC_9bin_507days_crab_response.hd5&quot;</span>
<span class="n">odir</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span>


<span class="n">maptree</span> <span class="o">=</span> <span class="n">get_hawc_file</span><span class="p">(</span><span class="n">maptree</span><span class="p">,</span> <span class="n">odir</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">get_hawc_file</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">odir</span><span class="p">)</span>

<span class="k">assert</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">maptree</span><span class="p">))</span>
<span class="k">assert</span><span class="p">(</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
</pre></div>
</div>
<p>Next, we need to define the region of interest (ROI) and instantiate the HAL plugin. The provided data file is a partial map covering 3˚ around the nominal position of the Crab nebula, so we need to make sure we use the same ROI (or a subset) here.</p>
<p>Some parameters of note:</p>
<p><code class="docutils literal notranslate"><span class="pre">flat_sky_pixels_size=0.1</span></code>: HAWC data is provided in counts binned according to the HealPIX scheme, with NSIDE=1024. To reduce computing time, the HAL plugin performs the convolution of the model with the detector response on a rectangular grid on the plane tangent to the center of the ROI. The convolved counts are finally converted back to HealPIX for the calculation of the likelihood. The parameter <code class="docutils literal notranslate"><span class="pre">flat_sky_pixel_size</span></code> of the <code class="docutils literal notranslate"><span class="pre">HAL</span></code> class controls the size of the grid used in the convolution with the detector response. Larger grid spacing reduced computing time, but can make the results less reliable. The grid spacing should not be significantly larger than the HealPix pixel size. Also note that model features smaller than the grid spacing may not contribute to the convolved source image. The default here is 0.1˚</p>
<p><code class="docutils literal notranslate"><span class="pre">hawc.set_active_measurements(1,</span> <span class="pre">9)</span></code>: HAWC divides its data in general <em>analysis bins</em>, each labeled with a string. The dataset provided here uses 9 bins labeled with integers from 1 to 9 and binned according to the fraction of PMTs hit by a particular shower, which is correlated to the energy of the primary particle. See <a class="reference external" href="https://iopscience.iop.org/article/10.3847/1538-4357/aa7555/meta">Abeysekara et al., 2017</a> for details about the meaning of the bins. There are two ways to set the ‘active’ bins (bins to be considered for the fit) in the <code class="docutils literal notranslate"><span class="pre">HAL</span></code> plugin: <code class="docutils literal notranslate"><span class="pre">set_active_measurement(bin_id_min=1,</span> <span class="pre">bin_id_max=9)</span></code> (can only be used with numerical bins) and <code class="docutils literal notranslate"><span class="pre">set_active_measurement(bin_list=[1,2,3,4,5,6,7,8,9])</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="n">capture</span>
<span class="kn">from</span> <span class="nn">hawc_hal</span> <span class="kn">import</span> <span class="n">HAL</span><span class="p">,</span> <span class="n">HealpixConeROI</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">threeML</span> <span class="kn">import</span> <span class="o">*</span>
<span class="n">silence_warnings</span><span class="p">()</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
<span class="kn">from</span> <span class="nn">jupyterthemes</span> <span class="kn">import</span> <span class="n">jtplot</span>
<span class="n">jtplot</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="n">context</span><span class="o">=</span><span class="s1">&#39;talk&#39;</span><span class="p">,</span> <span class="n">fscale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">set_threeML_style</span><span class="p">()</span>



<span class="c1"># Define the ROI. </span>
<span class="n">ra_crab</span><span class="p">,</span> <span class="n">dec_crab</span> <span class="o">=</span> <span class="mf">83.63</span><span class="p">,</span><span class="mf">22.02</span>
<span class="n">data_radius</span> <span class="o">=</span> <span class="mf">3.0</span> <span class="c1">#in degree</span>
<span class="n">model_radius</span> <span class="o">=</span> <span class="mf">8.0</span> <span class="c1">#in degree</span>

<span class="n">roi</span> <span class="o">=</span> <span class="n">HealpixConeROI</span><span class="p">(</span><span class="n">data_radius</span><span class="o">=</span><span class="n">data_radius</span><span class="p">,</span>
                     <span class="n">model_radius</span><span class="o">=</span><span class="n">model_radius</span><span class="p">,</span>
                     <span class="n">ra</span><span class="o">=</span><span class="n">ra_crab</span><span class="p">,</span>
                     <span class="n">dec</span><span class="o">=</span><span class="n">dec_crab</span><span class="p">)</span>

<span class="c1"># Instance the plugin</span>
<span class="n">hawc</span> <span class="o">=</span> <span class="n">HAL</span><span class="p">(</span><span class="s2">&quot;HAWC&quot;</span><span class="p">,</span>
           <span class="n">maptree</span><span class="p">,</span>
           <span class="n">response</span><span class="p">,</span>
           <span class="n">roi</span><span class="p">,</span>
           <span class="n">flat_sky_pixels_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="c1"># Use from bin 1 to bin 9</span>
<span class="n">hawc</span><span class="o">.</span><span class="n">set_active_measurements</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="exploratory-analysis">
<h2>Exploratory analysis<a class="headerlink" href="#exploratory-analysis" title="Permalink to this headline">¶</a></h2>
<p>Next, let’s explore the HAWC data.</p>
<p>First, print some information about the ROI and the data:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">hawc</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
</pre></div>
</div>
<p>Next, some plots. We can use the <code class="docutils literal notranslate"><span class="pre">display_stacked_image()</span></code> function to visualize the background-subtracted counts, summed over all (active) bins. This function smoothes the counts for plotting and takes the width of the smoothing kernel as an argument. This width must be non-zero.</p>
<p>First, let’s see what the counts look like without (or very little) smoothing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">hawc</span><span class="o">.</span><span class="n">display_stacked_image</span><span class="p">(</span><span class="n">smoothing_kernel_sigma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
</pre></div>
</div>
<p>What about smoothing it with a smoothing kernel comparable to the PSF? (Note the change in the color scale!)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig_smooth</span> <span class="o">=</span> <span class="n">hawc</span><span class="o">.</span><span class="n">display_stacked_image</span><span class="p">(</span><span class="n">smoothing_kernel_sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, let’s see how the data change from bin to bin (feel free to play around with the smoothing radius here)!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="nb">bin</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">]:</span>
    
    <span class="c1">#set only one active bin</span>
    <span class="n">hawc</span><span class="o">.</span><span class="n">set_active_measurements</span><span class="p">(</span><span class="nb">bin</span><span class="p">,</span> <span class="nb">bin</span><span class="p">)</span>

    <span class="n">fig</span> <span class="o">=</span> <span class="n">hawc</span><span class="o">.</span><span class="n">display_stacked_image</span><span class="p">(</span><span class="n">smoothing_kernel_sigma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s2">&quot;Bin </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">bin</span><span class="p">))</span>
  
</pre></div>
</div>
<p>Smaller bins have more events overall, but also more background, and a larger PSF.</p>
</div>
<div class="section" id="simple-model-fit">
<h2>Simple model fit<a class="headerlink" href="#simple-model-fit" title="Permalink to this headline">¶</a></h2>
<p>Let’s set up a simple one-source model with a log-parabolic spectrum. For now, the source position will be fixed to its nominal position.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define model</span>
<span class="n">spectrum</span> <span class="o">=</span> <span class="n">Log_parabola</span><span class="p">()</span>
<span class="n">source</span> <span class="o">=</span> <span class="n">PointSource</span><span class="p">(</span><span class="s2">&quot;crab&quot;</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="n">ra_crab</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">dec_crab</span><span class="p">,</span> <span class="n">spectral_shape</span><span class="o">=</span><span class="n">spectrum</span><span class="p">)</span>

<span class="n">spectrum</span><span class="o">.</span><span class="n">piv</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">TeV</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">piv</span><span class="o">.</span><span class="n">fix</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">spectrum</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="mf">1e-14</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># norm (in 1/(TeV cm2 s))</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">K</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e-35</span><span class="p">,</span> <span class="mf">1e-10</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">TeV</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">)</span>  <span class="c1"># without units energies would be in keV</span>

<span class="n">spectrum</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mf">2.5</span>  <span class="c1"># log parabolic alpha (index)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">alpha</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">2.</span><span class="p">)</span>

<span class="n">spectrum</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># log parabolic beta (curvature)</span>
<span class="n">spectrum</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>

<span class="n">model</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">complete</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Next, set up the likelihood object and run the fit. Fit results are written to disk so they can be read in again later.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1">#make sure to re-set the active bins before the fit</span>
<span class="n">hawc</span><span class="o">.</span><span class="n">set_active_measurements</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">DataList</span><span class="p">(</span><span class="n">hawc</span><span class="p">)</span>

<span class="n">jl</span> <span class="o">=</span> <span class="n">JointLikelihood</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">jl</span><span class="o">.</span><span class="n">set_minimizer</span><span class="p">(</span><span class="s2">&quot;minuit&quot;</span><span class="p">)</span>
<span class="n">param_df</span><span class="p">,</span> <span class="n">like_df</span> <span class="o">=</span> <span class="n">jl</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">results</span><span class="o">=</span><span class="n">jl</span><span class="o">.</span><span class="n">results</span>
<span class="n">results</span><span class="o">.</span><span class="n">write_to</span><span class="p">(</span><span class="s2">&quot;crab_lp_public_results.fits&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">results</span><span class="o">.</span><span class="n">optimized_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s2">&quot;crab_fit.yml&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="assessing-the-fit-quality">
<h2>Assessing the Fit Quality<a class="headerlink" href="#assessing-the-fit-quality" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">HAL</span></code> and <code class="docutils literal notranslate"><span class="pre">threeML</span></code> provide several ways to assess the quality of the provided model, both quantitatively and qualitatively.</p>
<p>For a first visual impression, we can display the model, excess (counts - background), background, and residuals (counts - model - background) for each bin.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">hawc</span><span class="o">.</span><span class="n">display_fit</span><span class="p">(</span><span class="n">smoothing_kernel_sigma</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span><span class="n">display_colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>Same, but with smoothing:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">hawc</span><span class="o">.</span><span class="n">display_fit</span><span class="p">(</span><span class="n">smoothing_kernel_sigma</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span><span class="n">display_colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The following plot provides a summary of the images above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">hawc</span><span class="o">.</span><span class="n">display_spectrum</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">GoodnessOfFit</span></code> module provides a numerical assessment of the goodness of fit, by comparing the best-fit likelihood from the fit to likelihood values seen in “simulated” data (background + source model + pseudo-random poissonian fluctuation).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">gof_obj</span> <span class="o">=</span> <span class="n">GoodnessOfFit</span><span class="p">(</span><span class="n">jl</span><span class="p">)</span>
<span class="n">gof</span><span class="p">,</span> <span class="n">data_frame</span><span class="p">,</span> <span class="n">like_data_frame</span> <span class="o">=</span> <span class="n">gof_obj</span><span class="o">.</span><span class="n">by_mc</span><span class="p">(</span><span class="n">n_iterations</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="n">gof</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">]</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Goodness of fit (p-value:)&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Meaning that </span><span class="si">{:.1f}% o</span><span class="s2">f simulations have a larger (worse) likelihood&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;and </span><span class="si">{:.1f}% o</span><span class="s2">f simulations have a smaller (better) likelihood than seen in data&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="p">)</span> <span class="p">)</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">like_data_frame</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">level_1</span> <span class="o">==</span> <span class="s2">&quot;total&quot;</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;-log(likelihood)&quot;</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;fluctuated source models&quot;</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="nb">range</span><span class="p">(</span><span class="mi">18000</span><span class="p">,</span><span class="mi">19000</span><span class="p">,</span><span class="mi">50</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">like_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;total&quot;</span><span class="p">,</span><span class="s2">&quot;-log(likelihood)&quot;</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;fit to data&quot;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="s2">&quot;orange&quot;</span> <span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xlabel</span> <span class="o">=</span> <span class="s2">&quot;-log(likelihood)&quot;</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">&quot;best&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Not too bad, but not great 🙃. The model might be improved by freeing the position or choosing another spectral shape. However, note that the detector response file provided here is the one used in the 2017 publication, which has since been superceeded by an updated detector model (only available inside the HAWC collaboration for now). Discrepancies between the simulated and true detector response may also worsen the goodness of fit.</p>
</div>
<div class="section" id="visualizing-the-fit-results">
<h2>Visualizing the Fit Results<a class="headerlink" href="#visualizing-the-fit-results" title="Permalink to this headline">¶</a></h2>
<p>Now that we have satisfied ourselves that the best-fit model describes the data reasonably well, let’s look at the fit parameters. First, let’s print them again:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">param_df</span>
</pre></div>
</div>
<p>Plot the spectrum using <code class="docutils literal notranslate"><span class="pre">threeML</span></code>’s <code class="docutils literal notranslate"><span class="pre">plot_spectra</span></code> convenience function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

<span class="n">plot_spectra</span><span class="p">(</span><span class="n">results</span><span class="p">,</span>
                   <span class="n">ene_min</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                   <span class="n">ene_max</span><span class="o">=</span><span class="mi">37</span><span class="p">,</span>
                   <span class="n">num_ene</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                   <span class="n">energy_unit</span><span class="o">=</span><span class="s1">&#39;TeV&#39;</span><span class="p">,</span>
                   <span class="n">flux_unit</span><span class="o">=</span><span class="s1">&#39;TeV/(s cm2)&#39;</span><span class="p">,</span>
                   <span class="n">subplot</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$E^2\,dN/dE$ [TeV cm$^{-2}$ s$^{-1}$]&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Energy [TeV]&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>What about visualizing the fit parameter’s uncertainties and their correlations? We can use <em>likelihood profiles</em> for that. We need to provide the range for the contours. We can derive a reasonable range from the best-fit values and their uncertainties.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">range_min</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">range_max</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">params</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">free_parameters</span>
<span class="n">N_param</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">free_parameters</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="p">)</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
    <span class="n">row</span> <span class="o">=</span> <span class="n">param_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="n">range_min</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;negative_error&quot;</span><span class="p">]</span>
    <span class="n">range_max</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="o">*</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;positive_error&quot;</span><span class="p">]</span> 
        
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">N_param</span><span class="p">):</span>
    <span class="n">p1</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">p2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())[(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">N_param</span><span class="p">]</span>
    
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">fig</span> <span class="o">=</span> <span class="n">jl</span><span class="o">.</span><span class="n">get_contours</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">range_min</span><span class="p">[</span><span class="n">p1</span><span class="p">],</span> <span class="n">range_max</span><span class="p">[</span><span class="n">p1</span><span class="p">],</span> <span class="mi">20</span><span class="p">,</span>
                                <span class="n">p2</span><span class="p">,</span> <span class="n">range_min</span><span class="p">[</span><span class="n">p2</span><span class="p">],</span> <span class="n">range_max</span><span class="p">[</span><span class="n">p2</span><span class="p">],</span> <span class="mi">20</span> <span class="p">)</span>
</pre></div>
</div>
<p>We can see that the index and normalization are essentially uncorrelated (as the pivot energy was chosen accordingly). There is significant correlation between the spectral index and the curvature parameter though.</p>
</div>
</div>


           </div>
           
          </div>

          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017--2021, G.Vianello, J. M. Burgess, N. Di Lalla, N. Omodei, H. Fleischhack.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>